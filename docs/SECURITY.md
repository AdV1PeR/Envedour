# Безопасность Envedour Bot

Рекомендации по безопасности и защите данных.

## Содержание

- [Изоляция процессов](#изоляция-процессов)
- [Ограничения ресурсов](#ограничения-ресурсов)
- [Защита данных](#защита-данных)
- [Сетевая безопасность](#сетевая-безопасность)
- [Обновления](#обновления)
- [Мониторинг безопасности](#мониторинг-безопасности)
- [Рекомендации](#рекомендации)

## Изоляция процессов

### Отдельный пользователь

Бот работает от пользователя `botuser` с минимальными правами:

```bash
# Создание пользователя
sudo useradd -r -s /bin/false botuser
```

**Особенности**:
- Системный пользователь (UID < 1000)
- Без shell доступа
- Минимальные права

### Ограниченные права

Бот имеет доступ только к необходимым ресурсам:
- `/opt/envedour-bot/` - директория бота
- `/dev/shm/videos/` - временные файлы
- Redis (только локальный)

### No New Privileges

Systemd сервис настроен с `NoNewPrivileges=true` (неявно через ограничения):

```ini
[Service]
User=botuser
Group=botuser
```

### Capabilities

Бот не требует специальных capabilities. Все операции выполняются с обычными правами пользователя.

## Ограничения ресурсов

### Memory Limits

```ini
[Service]
MemoryHigh=3.5G    # Предупреждение при превышении
MemoryMax=4G       # Максимальная память
```

**Защита**: Предотвращает исчерпание памяти системы.

### CPU Limits

```ini
[Service]
CPUQuota=380%      # Почти 4 ядра
```

**Защита**: Предотвращает перегрузку CPU.

### IO Limits

```ini
[Service]
IOWeight=100
```

**Защита**: Контроль ввода-вывода.

## Защита данных

### Нет логирования чувствительных данных

Бот **не логирует**:
- Chat ID пользователей (кроме доноров в конфигурации)
- URL (только временно для callback queries)
- Job ID (только в логах ошибок без контекста)

**Исключение**: Ошибки логируются, но без чувствительных данных.

### Временные файлы

- **Хранение**: tmpfs (`/dev/shm/videos`)
- **Автоматическая очистка**: После отправки файла
- **Права доступа**: Только для `botuser`

### Cookies

- **Хранение**: Только чтение оригинальных файлов
- **Обновления**: Во временных файлах в tmpfs
- **Права доступа**: `644` (только чтение для других)

### .env файлы

- **Права доступа**: `600` (только владелец)
- **Владелец**: `botuser`
- **Содержимое**: BOT_TOKEN, API credentials

**Проверка**:
```bash
ls -l /opt/envedour-bot/.env
# Должно быть: -rw------- 1 botuser botuser
```

## Сетевая безопасность

### Локальный Bot API

**Преимущества**:
- Работа через локальный API снижает нагрузку
- Нет внешних соединений (кроме Telegram)
- Контроль трафика

**Настройка**: `LOCAL_API_URL=http://localhost:8089`

### Firewall

**Рекомендации**:
- Ограничьте доступ к портам
- Закройте ненужные порты
- Используйте fail2ban для защиты

**Пример**:
```bash
# Разрешить только локальный доступ к Redis
sudo ufw deny 6379
sudo ufw allow from 127.0.0.1 to any port 6379

# Разрешить только локальный доступ к Bot API
sudo ufw deny 8089
sudo ufw allow from 127.0.0.1 to any port 8089
```

### HTTPS (для удаленного API)

Если используете удаленный Bot API, используйте HTTPS:

```bash
LOCAL_API_URL=https://your-domain.com:8089
```

## Обновления

### Регулярные обновления

**Рекомендуется**:
1. **yt-dlp**: Еженедельно
   ```bash
   sudo pip3 install --upgrade "yt-dlp[default,curl-cffi]"
   ```

2. **Go зависимости**: При обновлении кода
   ```bash
   go mod download
   go mod tidy
   ```

3. **Системные пакеты**: Регулярно
   ```bash
   sudo apt-get update
   sudo apt-get upgrade
   ```

### Обновление cookies

**Рекомендуется**: Обновлять cookies файлы еженедельно или при проблемах.

### Мониторинг уязвимостей

- Следите за обновлениями зависимостей
- Проверяйте CVE для используемых библиотек
- Обновляйте систему регулярно

## Мониторинг безопасности

### Проверка прав доступа

```bash
# Проверка .env файлов
ls -l /opt/envedour-bot/.env
ls -l /opt/telegram-bot-api/.env

# Проверка cookies файлов
ls -l /opt/envedour-bot/*_cookies.txt

# Проверка бинарника
ls -l /opt/envedour-bot/envedour-bot-arm64
```

### Проверка процессов

```bash
# Процессы бота
ps aux | grep envedour-bot

# Должны работать от botuser
```

### Проверка сетевых соединений

```bash
# Активные соединения
netstat -tuln | grep -E "6379|8089"

# Должны быть только localhost
```

### Аудит логов

```bash
# Проверка подозрительной активности
sudo journalctl -u envedour-down-bot | grep -i "error\|failed\|denied"

# Регулярный аудит
sudo journalctl -u envedour-down-bot --since "1 day ago" > audit.log
```

## Рекомендации

### Общие рекомендации

1. **Регулярные обновления**: Обновляйте yt-dlp и зависимости
2. **Мониторинг**: Регулярно проверяйте логи
3. **Резервное копирование**: Создавайте резервные копии конфигурации
4. **Ограничение доступа**: Используйте firewall
5. **Минимальные права**: Не запускайте от root

### Для продакшена

1. **Отдельный сервер**: Используйте выделенный сервер
2. **Мониторинг**: Настройте алерты
3. **Логирование**: Сохраняйте логи для аудита
4. **Резервное копирование**: Автоматическое резервное копирование
5. **Обновления**: Автоматические обновления безопасности

### Для разработки

1. **Тестирование**: Тестируйте изменения перед продакшеном
2. **Версионирование**: Используйте git для версионирования
3. **Документация**: Документируйте изменения
4. **Code review**: Проводите code review перед коммитом

### Для пользователей

1. **Приватность**: Бот не сохраняет пользовательские данные
2. **Безопасность**: Все файлы удаляются после отправки
3. **Логирование**: Минимальное логирование без чувствительных данных

## Чеклист безопасности

### Установка

- [ ] Бот работает от отдельного пользователя
- [ ] .env файлы имеют права 600
- [ ] Cookies файлы имеют права 644
- [ ] Бинарник имеет права 755
- [ ] Firewall настроен правильно

### Эксплуатация

- [ ] Регулярные обновления yt-dlp
- [ ] Регулярные обновления cookies
- [ ] Мониторинг логов
- [ ] Проверка прав доступа
- [ ] Резервное копирование конфигурации

### Мониторинг

- [ ] Регулярный аудит логов
- [ ] Проверка сетевых соединений
- [ ] Проверка процессов
- [ ] Проверка использования ресурсов

---

**Важно**: Безопасность - это процесс, а не состояние. Регулярно проверяйте и обновляйте систему.
