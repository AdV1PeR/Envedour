# Производительность Envedour Bot

Руководство по оптимизации и настройке производительности.

## Содержание

- [Целевые показатели](#целевые-показатели)
- [ARM Оптимизации](#arm-оптимизации)
- [Оптимизация памяти](#оптимизация-памяти)
- [Оптимизация CPU](#оптимизация-cpu)
- [Оптимизация сети](#оптимизация-сети)
- [Оптимизация Redis](#оптимизация-redis)
- [Бенчмарки](#бенчмарки)
- [Рекомендации](#рекомендации)

## Целевые показатели

### Для OrangePi Zero3 (4GB RAM, 4 ядра @ 1.5GHz)

| Метрика | Целевое значение | Максимум |
|---------|-----------------|----------|
| Одновременные пользователи | 50-100 | 150+ |
| Размер файла | До 2GB | До 4GB |
| Скорость загрузки | До 100Mbps | Ограничено сетью |
| Использование памяти | <3.5GB | <4GB |
| Температура CPU | <80°C | <85°C |
| Время обработки (1080p, 5 мин) | 2-5 минут | Зависит от размера |

### Для Raspberry Pi 4 (4GB+ RAM)

| Метрика | Целевое значение | Максимум |
|---------|-----------------|----------|
| Одновременные пользователи | 50-100 | 150+ |
| Размер файла | До 2GB | До 4GB |
| Скорость загрузки | До 100Mbps | Ограничено сетью |
| Использование памяти | <3.5GB | <4GB |
| Температура CPU | <75°C | <80°C |

## ARM Оптимизации

### ARM NEON SIMD

**Описание**: Использование SIMD инструкций для ускорения обработки видео.

**Включение**:
- FFmpeg автоматически использует NEON при компиляции
- Проверка: `ffmpeg -version | grep neon`

**Ускорение**: До 4x для операций с видео.

### Оптимизация компиляции

**Флаги сборки** (уже включены в Makefile):
```makefile
-ldflags="-s -w -extldflags '-Wl,--hash-style=gnu'"
```

**Оптимизации**:
- `-s`: Удаление символов
- `-w`: Отключение предупреждений
- `-extldflags`: Оптимизация линковки

### Термальный мониторинг

**Описание**: Автоматическая защита от перегрева на ARM64.

**Параметры**:
- Порог: 85°C
- Интервал проверки: 5 секунд
- Действие: Приостановка обработки

**Включение**: Флаг `--arm-optimized` при запуске.

## Оптимизация памяти

### tmpfs для временных файлов

**Преимущества**:
- Файлы хранятся в RAM
- Быстрый доступ
- Автоматическая очистка при перезагрузке

**Настройка**:
```bash
# В /etc/fstab
tmpfs /dev/shm/videos tmpfs size=2G,nr_blocks=524288,nr_inodes=65536,noatime,nodev,nosuid 0 0
```

**Размер**: Рекомендуется 2GB для 4GB RAM.

### Go Memory Limits

**Настройка**:
```bash
# В systemd service
Environment="GOMEMLIMIT=512MiB"
Environment="GOGC=50"
```

**Параметры**:
- `GOMEMLIMIT`: Максимальная память для Go heap
- `GOGC`: Процент для сборки мусора (50 = баланс)

### Проверка памяти перед загрузкой

**Параметр**: `MIN_FREE_MEM_MB`

**Рекомендации**:
- Минимум: 256 MB
- Рекомендуется: 512 MB
- Для стабильности: 1024 MB

**Настройка**:
```bash
MIN_FREE_MEM_MB=512
```

### Ограничение размера файлов

**Параметр**: `MAX_FILE_SIZE_MB`

**Рекомендации**:
- Для 4GB RAM: 1024-2048 MB
- Для 8GB+ RAM: 2048-4096 MB

**Настройка**:
```bash
MAX_FILE_SIZE_MB=2048
```

## Оптимизация CPU

### Количество воркеров

**Параметр**: `WORKER_COUNT`

**Рекомендации**:
- Для 2 ядер: 2-3
- Для 4 ядер: 4-6
- Для 8+ ядер: 6-8

**Настройка**:
```bash
WORKER_COUNT=4
```

### GOMAXPROCS

**Описание**: Количество потоков Go.

**Настройка** (в systemd service):
```ini
Environment="GOMAXPROCS=4"
```

**Рекомендация**: Равно количеству CPU ядер.

### CPU Affinity

**Описание**: Привязка процесса к конкретным ядрам.

**Настройка** (в systemd service):
```ini
CPUAffinity=0 1 2 3
```

### Nice Priority

**Описание**: Приоритет процесса.

**Настройка** (уже включено):
```ini
Nice=-10
```

**Значения**:
- `-20` - Высший приоритет
- `0` - Обычный приоритет
- `19` - Низший приоритет

## Оптимизация сети

### TCP Tuning

**Скрипт**: `deploy/network-tuning.sh`

**Параметры** (в sysctl.conf):
```conf
# TCP оптимизации
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_congestion_control = bbr
```

### aria2c Оптимизации

**Уже настроено** в executor.go:
```go
"--external-downloader-args", "aria2c:-j16 -x16 -s16 --file-allocation=falloc --stream-piece-selector=geom --max-download-limit=0"
```

**Параметры**:
- `-j16`: 16 соединений
- `-x16`: 16 сегментов
- `-s16`: 16 разделений
- `--file-allocation=falloc`: Быстрое выделение файла

## Оптимизация Redis

### Конфигурация памяти

**Файл**: `/etc/redis/redis.conf.d/arm-optimized.conf`

```conf
maxmemory 1gb
maxmemory-policy allkeys-lru
```

**Параметры**:
- `maxmemory`: Максимальная память
- `maxmemory-policy`: Политика очистки (`allkeys-lru` = удаление наименее используемых)

### Отключение персистентности

**Для производительности** (только RAM):
```conf
save ""
```

**Примечание**: Данные теряются при перезагрузке, но это нормально для очереди задач.

### Активное перехеширование

```conf
activerehashing yes
```

**Преимущества**: Равномерное распределение ключей.

## Бенчмарки

### Тест скачивания

```bash
# YouTube 1080p (5 минут)
time yt-dlp -f "bestvideo[height<=1080]+bestaudio/best[height<=1080]" <youtube_url>

# Ожидаемое время: 2-5 минут
```

### Тест обработки

```bash
# FFmpeg обработка
time ffmpeg -i input.mp4 -c:v copy -c:a copy output.mp4

# Ожидаемое время: <10 секунд для копирования
```

### Тест отправки

```bash
# Измеряется автоматически в логах
# Ожидаемое время: 10-30 секунд для 100MB файла
```

### Тест памяти

```bash
# Запустите тест
./scripts/test-memory.sh

# Проверьте использование
free -h
```

### Тест температуры

```bash
# Запустите тест
./scripts/test-thermal.sh

# Мониторинг температуры
watch -n 1 'echo $(($(cat /sys/class/thermal/thermal_zone0/temp) / 1000))°C'
```

## Рекомендации

### Для слабого железа (2GB RAM, 2 ядра)

```bash
WORKER_COUNT=2
MAX_FILE_SIZE_MB=1024
MIN_FREE_MEM_MB=512
GOMEMLIMIT=256MiB
```

### Для среднего железа (4GB RAM, 4 ядра)

```bash
WORKER_COUNT=4
MAX_FILE_SIZE_MB=2048
MIN_FREE_MEM_MB=256
GOMEMLIMIT=512MiB
```

### Для мощного железа (8GB+ RAM, 8+ ядер)

```bash
WORKER_COUNT=6
MAX_FILE_SIZE_MB=4096
MIN_FREE_MEM_MB=256
GOMEMLIMIT=1GiB
```

### Общие рекомендации

1. **Мониторинг**: Регулярно проверяйте метрики
2. **Температура**: Поддерживайте <80°C
3. **Память**: Оставляйте запас 512MB+
4. **Очередь**: Не накапливайте слишком много задач
5. **Обновления**: Регулярно обновляйте yt-dlp и зависимости

### Увеличение пропускной способности

1. **Увеличьте WORKER_COUNT** (но не больше ядер CPU)
2. **Используйте локальный Bot API**
3. **Оптимизируйте сеть** (TCP tuning)
4. **Используйте качественный интернет**

### Снижение использования памяти

1. **Уменьшите MAX_FILE_SIZE_MB**
2. **Уменьшите размер tmpfs**
3. **Уменьшите WORKER_COUNT**
4. **Увеличьте MIN_FREE_MEM_MB**

### Снижение температуры

1. **Добавьте охлаждение** (радиатор/вентилятор)
2. **Уменьшите WORKER_COUNT**
3. **Ограничьте нагрузку**
4. **Используйте меньшее качество по умолчанию**

---

**Следующий шаг**: См. [MONITORING.md](MONITORING.md) для отслеживания метрик
